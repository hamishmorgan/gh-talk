---
description: "Pull request workflow for gh-talk development"
alwaysApply: true
---

# Pull Request Workflow

**Purpose**: Complete workflow for contributing code via pull requests with branch protection enabled.

**When to Use**: For ALL code changes - branch protection requires PRs, no direct commits to main.

**Prerequisites**:
- Git repository cloned locally
- `gh` CLI installed and authenticated
- `make` targets available (build, test, lint, ci, fmt)
- `gh-talk` extension installed for review management
- Branch protection enabled on main branch

**Branch Protection Enabled**: All changes via PRs, no direct commits to main.

## Agent Attribution Requirements ü§ñ

**ALL agent-generated content MUST be clearly identified:**

1. **Commit Messages**: Use `--author` flag AND add signature
   ```bash
   git commit --author="Cursor <cursor@noreply.local>" -m "Description

ü§ñ Generated by Cursor"
   ```

2. **PR Descriptions**: End with agent signature
   ```markdown
   ## Summary
   ...

   ---
   ü§ñ *Generated by Cursor*
   ```

3. **PR Comments**: Include agent signature
   ```
   Comment text here...

   ü§ñ Cursor
   ```

4. **Review Replies** (via gh-talk): End with agent signature
   ```bash
   gh talk reply PRRT_xxx "Response text

ü§ñ Cursor"
   ```

**Purpose**: Transparency about AI contributions, easy identification of agent work

**Format**: `ü§ñ [Agent Name]` or `ü§ñ *Generated by [Agent]*`

## Branch Creation

**Naming Convention:**
```
<agent>_<descriptive_name>

Where:
  <agent> = cursor | copilot | claude
  <descriptive_name> = lowercase_with_underscores
```

**Examples:**
- `cursor_add_bulk_operations`
- `cursor_fix_graphql_type_error`
- `cursor_update_readme_examples`
- `claude_improve_error_messages`

**Rules:**
- NO type prefixes (feat/, fix/, etc.)
- NO slashes (can cause git directory issues)
- Use underscores for word separation
- Keep descriptive and clear

## Workflow Steps

### 1. Create Feature Branch

```bash
git checkout main
git pull origin main
git checkout -b cursor_your_feature_name
```

### 2. Make Changes

- Implement feature/fix
- **Write tests for ALL new code (100% coverage of new code)**
- Update documentation if needed
- Follow AGENTS.md guidelines
- **Critically review your own changes**:
  - Read through every line you changed
  - Question design decisions
  - Look for edge cases
  - Consider error scenarios
  - Check for code smells

### 3. Commit Frequently

**Format**: `<clear description of what changed>`

**AI Attribution** (REQUIRED):
```bash
git commit --author="Cursor <cursor@noreply.local>" -m "descriptive message"
```

**Examples:**
```bash
git commit --author="Cursor <cursor@noreply.local>" -m "Add JSON output to list command"
git commit --author="Cursor <cursor@noreply.local>" -m "Handle empty thread list gracefully"
git commit --author="Cursor <cursor@noreply.local>" -m "Add unit tests for emoji parsing (100% coverage)"
git commit --author="Cursor <cursor@noreply.local>" -m "Update README with new examples"
```

**Rules:**
- NO type prefixes (feat:, fix:, etc.) - just describe what you did
- Descriptive and clear
- First letter capitalized
- AI attribution required (--author flag)
- Add agent signature at end: `ü§ñ Generated by Cursor`

**Example with signature:**
```bash
git commit --author="Cursor <cursor@noreply.local>" -m "Add JSON output to list command

Implements proper JSON formatting with all thread fields.

ü§ñ Generated by Cursor"
```

### 4. Run Local Checks BEFORE Pushing

```bash
make fmt   # Format code (gofmt, goimports)
make ci    # Runs lint + test + format check
```

**Required**:
- All tests pass
- No linter errors
- Code formatted (gofmt + goimports)
- **100% coverage for new code** (not existing code)

**DO NOT push failing code to PR** - fix locally first.

### 5. Push to Branch

```bash
git push origin <branch-name>

# If branch doesn't exist yet, set upstream:
git push -u origin <branch-name>
```

### 6. Create Pull Request

```bash
gh pr create \
  --title "Descriptive title (no type prefix)" \
  --body "## Summary

Brief description of changes.

## Changes

- What changed
- Why it changed  
- How to test

## Closes

Closes #<issue-number> (if applicable)

---
ü§ñ *Generated by Cursor*"
```

**Required**: All PR descriptions MUST include agent signature at the end

### 6.5. Request Copilot Review

**Immediately after creating PR:**

```bash
# Request Copilot review
gh pr edit <PR> --add-reviewer copilot

# Or if that doesn't work, trigger via comment
gh pr comment <PR> --body "@copilot please review"
```

**IMPORTANT**: Always request Copilot review when:
- PR is first created
- Significant changes are pushed
- After addressing review feedback

### 7. Monitor CI and Fix Failures

**Check CI status (returns exit code 0 only if ALL pass):**
```bash
gh pr checks <PR>
# Exit code 0 = all pass
# Exit code 1 = failures or pending
```

**If ANY checks fail or are pending:**
```bash
# View failed logs
gh run view --log-failed

# Fix issues
# Commit and push fix
# Wait for re-run

# NEVER claim "ready to merge" until this shows ALL pass:
gh pr checks <PR>
```

**Watch run in real-time:**
```bash
gh run watch  # Watch latest run
```

**CRITICAL**: Do NOT proceed to "Post Status Updates" or "Request Merge" until `gh pr checks` returns exit code 0 (all checks pass).

### 8. Address Feedback

**Check ALL comment types:**

```bash
# 1. General PR comments
gh pr view --comments

# 2. Inline review comments (CRITICAL - don't miss these!)
gh talk list threads  # Use our own tool!

# 3. Review status
gh pr view --json reviewDecision --jq '.reviewDecision'
```

**For EACH comment (in order):**

1. **Respond BEFORE fixing**:
   ```bash
   gh talk reply PRRT_xxx "üëÄ Looking into this

ü§ñ Cursor"
   ```

2. **Make the fix**: Implement the change

3. **Test the fix**: Ensure it works and has 100% test coverage

4. **Respond AFTER fixing**:
   ```bash
   gh talk reply PRRT_xxx "Fixed in commit abc123. [Brief explanation]

ü§ñ Cursor" --resolve --react üëç
   ```

5. **Commit**: Descriptive message with AI attribution and signature

6. **Push immediately**: Don't accumulate multiple fixes

7. **Request re-review**: After pushing fixes, request Copilot to review again
   ```bash
   gh pr comment <PR> --body "@copilot please re-review"
   ```

**Emoji response guide:**
- üëÄ Before fixing (acknowledging)
- üëç After fixing (confirmation)
- ‚ù§Ô∏è For helpful suggestions
- üéâ For great feedback
- üòï If unclear (ask for clarification)

**Agent Signature Required:**
- ALL replies must end with: `ü§ñ Cursor` (or `ü§ñ Claude`, `ü§ñ Copilot`)
- Clearly indicates agent authorship
- Robot emoji makes it visually obvious

**After all comments in thread addressed:**
```bash
# Resolve the thread
gh talk resolve PRRT_xxx

# Hide original comments to clean up
gh talk hide PRRC_xxx --reason resolved
```

### 9. Keep PR Updated

**Update PR Description as Changes Evolve:**

```bash
# If PR scope changed, update description
gh pr edit <PR> --body "Updated description

## Summary
...

## Changes
- List all changes (including new ones)
...

---
ü§ñ *Generated by Cursor*"
```

**Update when:**
- Scope expanded (more files changed)
- Approach changed significantly
- New issues closed
- Significant commits added

**Before each push, check if behind:**

```bash
gh pr view --json mergeStateStatus --jq '.mergeStateStatus'

# If "BEHIND", rebase:
git fetch origin main
git rebase origin/main
# Fix conflicts if any
git push --force-with-lease  # Safe force push
```

### 10. Self-Review Before Requesting Merge

**FIRST: Verify CI Actually Passes**
```bash
# This MUST return exit code 0 (all checks pass)
gh pr checks <PR>

# If exit code 1: NOT ready - go back to step 7
```

**Checklist (only proceed if CI passes):**
- [ ] **All CI checks passing** (verified with `gh pr checks` exit code 0)
- [ ] All review comments addressed
- [ ] All review threads resolved
- [ ] All resolved comments hidden
- [ ] Copilot review satisfied (no unresolved feedback)
- [ ] Tests added/updated with **100% coverage for new code**
- [ ] Code formatted (`make fmt`)
- [ ] Documentation updated
- [ ] No linter warnings
- [ ] Coverage maintained at >60%
- [ ] **PR description updated** (reflects final state)
- [ ] AGENTS.md updated (if new patterns)
- [ ] Branch is up to date with main

### 11. Post Status Updates

**When posting status updates:**

```bash
# Hide previous status updates as outdated
gh pr view <PR> --comments --json comments | \
  jq -r '.comments[] | select(.body | contains("Status Update")) | .node_id' | \
  xargs -I {} gh talk hide {} --reason outdated

# Post new status update
gh pr comment <PR> --body "## Status Update

Progress summary here...

‚úì Items completed
‚è≥ Items in progress (e.g., CI running)
‚ùå Items blocked

ü§ñ Cursor"
```

**CRITICAL Rules:**
- Title: "Status Update" (not "Final" or "Ready to Merge")
- Hide previous status updates as outdated
- **NEVER claim "ready to merge" while CI is failing or pending**
- Check `gh pr checks` exit code before claiming readiness
- Don't claim finality (there may be more to do)
- Always include agent signature

### 12. Request Merge (User Approval Required)

**DO NOT merge yourself** - wait for user to approve and merge.

**ONLY when `gh pr checks` returns exit code 0:**
```bash
# Verify ALL checks pass
gh pr checks <PR>
# Exit code must be 0

# Then post:
gh pr comment <PR> --body "## Status Update

‚úì All checks passing (verified: gh pr checks returned 0)
‚úì All feedback addressed
‚úì Tests added
‚úì Documentation updated

Awaiting your approval to merge.

ü§ñ Cursor"
```

**CRITICAL**:
- NEVER say "ready to merge" if CI is failing or pending
- ALWAYS verify `gh pr checks` exit code 0 before claiming readiness
- If checks fail, go back to step 7 (fix and monitor)
- User approval required even if all checks pass

## Using gh-talk for PR Reviews

**Now that gh-talk exists, USE IT:**

```bash
# List all review threads
gh talk list threads

# Reply before fixing
gh talk reply PRRT_xxx "üëÄ Looking into this"

# After fixing, reply and resolve
gh talk reply PRRT_xxx "Fixed!" --resolve --react üëç

# Check status
gh talk status

# Show thread details
gh talk show PRRT_xxx

# Hide resolved comments
gh talk hide PRRC_xxx --reason resolved
```

**If gh-talk has issues:**
- Create GitHub issue documenting the problem
- Use fallback: `gh api` or web UI temporarily
- Continue with PR workflow
- Fix gh-talk issue separately

**Rebuilding gh-talk during development:**
```bash
# After making changes to gh-talk code
make build
gh extension remove gh-talk
gh extension install .

# Or use make target
make install  # Does both automatically
```

## Common Patterns

### Quick PR Creation

```bash
# From feature branch (cursor_feature_name)
make fmt                   # Format first
make ci                    # Verify locally
git push -u origin cursor_feature_name
gh pr create               # Add description with ü§ñ signature
```

**Remember**: Add `ü§ñ *Generated by Cursor*` to PR description

### Incremental Fixes

```bash
# After review feedback
# For each comment:

# 1. Respond before fixing
gh talk reply PRRT_xxx "üëÄ Working on this now"

# 2. Fix issue 1
git add <files>
git commit --author="Cursor <cursor@noreply.local>" -m "Address review comment about X"
make fmt  # Format before push
git push

# 3. Respond after fixing
gh talk reply PRRT_xxx "Fixed in latest commit" --resolve --react üëç

# 4. Hide resolved comment
gh talk hide PRRC_xxx --reason resolved

# Repeat for each comment - push after each fix for incremental review

# Note: All replies include ü§ñ Cursor signature
```

### Rebase and Update

```bash
# Keep PR fresh
git fetch origin main
git rebase origin/main
# Resolve conflicts
make ci  # Verify still works
git push --force-with-lease
```

## Anti-Patterns (DON'T)

‚ùå **Direct commits to main** - Branch protection prevents this
‚ùå **Large PRs** - Keep changes focused to <300 lines; larger PRs require justification in description
‚ùå **Pushing without testing** - Run `make ci` first
‚ùå **Accumulating changes** - Commit and push incrementally
‚ùå **Force push** - Use `--force-with-lease` (safer)
‚ùå **Merging yourself** - Wait for user approval
‚ùå **Missing inline comments** - Check with `gh talk list threads`
‚ùå **Ignoring CI failures** - Fix before requesting review

## Quick Reference

```bash
# Create PR
git checkout -b cursor_feature_name
# ... make changes ...
make fmt
make ci
git push -u origin cursor_feature_name
gh pr create

# Address feedback
gh talk list threads                          # See all comments
gh talk reply PRRT_xxx "üëÄ Looking"           # Respond before
# ... fix issue ...
make fmt && make ci                           # Format and test
git commit --author="Cursor <cursor@noreply.local>" -m "Fix issue"
git push
gh talk reply PRRT_xxx "Fixed!" --resolve --react üëç  # Respond after
gh talk hide PRRC_xxx --reason resolved       # Clean up

# Keep updated
git fetch && git rebase origin/main
git push --force-with-lease

# Check readiness
gh pr checks
gh talk status
make ci
```

---

**Remember**: Quality over speed. Test locally, commit incrementally, never push failing code.

---

**Related**:
- `AGENTS.md` - Code standards, patterns, and project context
- `.cursor/rules/creating-rules.mdc` - How to create new cursor rules
- `.github/workflows/*.yml` - CI/CD pipeline configuration
- `Makefile` - Development task automation

**Last Updated**: 2025-11-03

ü§ñ *Generated by Cursor*
