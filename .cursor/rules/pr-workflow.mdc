---
description: "Pull request workflow for gh-talk development"
alwaysApply: true
---

# Pull Request Workflow

**Branch Protection Enabled**: All changes via PRs, no direct commits to main.

## Branch Creation

**Naming Convention:**
```
<agent>_<descriptive_name>

Where:
  <agent> = cursor | copilot | claude
  <descriptive_name> = lowercase_with_underscores
```

**Examples:**
- `cursor_add_bulk_operations`
- `cursor_fix_graphql_type_error`
- `cursor_update_readme_examples`
- `claude_improve_error_messages`

**Rules:**
- NO type prefixes (feat/, fix/, etc.)
- NO slashes (can cause git directory issues)
- Use underscores for word separation
- Keep descriptive and clear

## Workflow Steps

### 1. Create Feature Branch

```bash
git checkout main
git pull origin main
git checkout -b cursor_your_feature_name
```

### 2. Make Changes

- Implement feature/fix
- **Write tests for ALL new code (100% coverage of new code)**
- Update documentation if needed
- Follow AGENTS.md guidelines
- **Critically review your own changes**:
  - Read through every line you changed
  - Question design decisions
  - Look for edge cases
  - Consider error scenarios
  - Check for code smells

### 3. Commit Frequently

**Format**: `<clear description of what changed>`

**AI Attribution** (REQUIRED):
```bash
git commit --author="Cursor <cursor@noreply.local>" -m "descriptive message"
```

**Examples:**
```bash
git commit --author="Cursor <cursor@noreply.local>" -m "Add JSON output to list command"
git commit --author="Cursor <cursor@noreply.local>" -m "Handle empty thread list gracefully"
git commit --author="Cursor <cursor@noreply.local>" -m "Add unit tests for emoji parsing (100% coverage)"
git commit --author="Cursor <cursor@noreply.local>" -m "Update README with new examples"
```

**Rules:**
- NO type prefixes (feat:, fix:, etc.) - just describe what you did
- Descriptive and clear
- First letter capitalized
- AI attribution required

### 4. Run Local Checks BEFORE Pushing

```bash
make fmt   # Format code (gofmt, goimports)
make ci    # Runs lint + test + format check
```

**Required**:
- All tests pass
- No linter errors
- Code formatted (gofmt + goimports)
- **100% coverage for new code** (not existing code)

**DO NOT push failing code to PR** - fix locally first.

### 5. Push to Branch

```bash
git push origin <branch-name>

# If branch doesn't exist yet, set upstream:
git push -u origin <branch-name>
```

### 6. Create Pull Request

```bash
gh pr create \
  --title "feat: descriptive title" \
  --body "Description of changes

Closes #<issue-number> (if applicable)

Changes:
- What changed
- Why it changed
- How to test"
```

### 7. Monitor CI

```bash
# Check status
gh pr checks

# Watch run
gh run watch

# If failed, view logs
gh run view --log-failed
```

### 8. Address Feedback

**Check ALL comment types:**

```bash
# 1. General PR comments
gh pr view --comments

# 2. Inline review comments (CRITICAL - don't miss these!)
gh talk list threads  # Use our own tool!

# 3. Review status
gh pr view --json reviewDecision --jq '.reviewDecision'
```

**For EACH comment (in order):**

1. **Respond BEFORE fixing**: `gh talk reply PRRT_xxx "üëÄ Looking into this"`
2. **Make the fix**: Implement the change
3. **Test the fix**: Ensure it works and has 100% test coverage
4. **Respond AFTER fixing**: `gh talk reply PRRT_xxx "Fixed in this commit" --resolve --react üëç`
5. **Commit**: Descriptive message with AI attribution
6. **Push immediately**: Don't accumulate multiple fixes

**Emoji response guide:**
- üëÄ Before fixing (acknowledging)
- üëç After fixing (confirmation)
- ‚ù§Ô∏è For helpful suggestions
- üéâ For great feedback
- üòï If unclear (ask for clarification)

**After all comments in thread addressed:**
```bash
# Resolve the thread
gh talk resolve PRRT_xxx

# Hide original comments to clean up
gh talk hide PRRC_xxx --reason resolved
```

### 9. Keep PR Updated

**Before each push, check if behind:**

```bash
gh pr view --json mergeStateStatus --jq '.mergeStateStatus'

# If "BEHIND", rebase:
git fetch origin main
git rebase origin/main
# Fix conflicts if any
git push --force-with-lease  # Safe force push
```

### 10. Self-Review Before Requesting Merge

**Checklist:**
- [ ] All CI checks passing
- [ ] All review comments addressed
- [ ] All review threads resolved
- [ ] All resolved comments hidden
- [ ] Tests added/updated with **100% coverage for new code**
- [ ] Code formatted (`make fmt`)
- [ ] Documentation updated
- [ ] No linter warnings
- [ ] AGENTS.md updated (if new patterns)
- [ ] Branch is up to date with main

### 11. Request Merge (User Approval Required)

**DO NOT merge yourself** - wait for user to approve and merge.

**Report readiness:**
```
‚úì All checks passing
‚úì All feedback addressed
‚úì Tests added
‚úì Documentation updated
‚úì Ready for merge

Awaiting your approval to merge.
```

## Using gh-talk for PR Reviews

**Now that gh-talk exists, USE IT:**

```bash
# List all review threads
gh talk list threads

# Reply before fixing
gh talk reply PRRT_xxx "üëÄ Looking into this"

# After fixing, reply and resolve
gh talk reply PRRT_xxx "Fixed!" --resolve --react üëç

# Check status
gh talk status

# Show thread details
gh talk show PRRT_xxx

# Hide resolved comments
gh talk hide PRRC_xxx --reason resolved
```

**If gh-talk has issues:**
- Create GitHub issue documenting the problem
- Use fallback: `gh api` or web UI temporarily
- Continue with PR workflow
- Fix gh-talk issue separately

**Rebuilding gh-talk during development:**
```bash
# After making changes to gh-talk code
make build
gh extension remove gh-talk
gh extension install .

# Or use make target
make install  # Does both automatically
```

## Common Patterns

### Quick PR Creation

```bash
# From feature branch (cursor_feature_name)
make fmt                   # Format first
make ci                    # Verify locally
git push -u origin cursor_feature_name
gh pr create --fill        # Use commit messages
```

### Incremental Fixes

```bash
# After review feedback
# For each comment:

# 1. Respond before fixing
gh talk reply PRRT_xxx "üëÄ Working on this now"

# 2. Fix issue 1
git add <files>
git commit --author="Cursor <cursor@noreply.local>" -m "Address review comment about X"
make fmt  # Format before push
git push

# 3. Respond after fixing
gh talk reply PRRT_xxx "Fixed in latest commit" --resolve --react üëç

# 4. Hide resolved comment
gh talk hide PRRC_xxx --reason resolved

# Repeat for each comment - push after each fix for incremental review
```

### Rebase and Update

```bash
# Keep PR fresh
git fetch origin main
git rebase origin/main
# Resolve conflicts
make ci  # Verify still works
git push --force-with-lease
```

## Anti-Patterns (DON'T)

‚ùå **Direct commits to main** - Branch protection prevents this
‚ùå **Large PRs** - Keep changes focused (<300 lines if possible)
‚ùå **Pushing without testing** - Run `make ci` first
‚ùå **Accumulating changes** - Commit and push incrementally
‚ùå **Force push** - Use `--force-with-lease` (safer)
‚ùå **Merging yourself** - Wait for user approval
‚ùå **Missing inline comments** - Check with `gh talk list threads`
‚ùå **Ignoring CI failures** - Fix before requesting review

## Quick Reference

```bash
# Create PR
git checkout -b cursor_feature_name
# ... make changes ...
make fmt
make ci
git push -u origin cursor_feature_name
gh pr create

# Address feedback
gh talk list threads                          # See all comments
gh talk reply PRRT_xxx "üëÄ Looking"           # Respond before
# ... fix issue ...
make fmt && make ci                           # Format and test
git commit --author="Cursor <cursor@noreply.local>" -m "Fix issue"
git push
gh talk reply PRRT_xxx "Fixed!" --resolve --react üëç  # Respond after
gh talk hide PRRC_xxx --reason resolved       # Clean up

# Keep updated
git fetch && git rebase origin/main
git push --force-with-lease

# Check readiness
gh pr checks
gh talk status
make ci
```

---

**Remember**: Quality over speed. Test locally, commit incrementally, never push failing code.
