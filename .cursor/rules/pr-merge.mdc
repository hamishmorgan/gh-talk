---
description: "Final PR review, merge request, and post-merge cleanup"
alwaysApply: false
---

# Merging Pull Requests

**Purpose**: Final verification, status update, and merge workflow.

**When to Use**: 
- When all feedback addressed and CI passing (invoke with `/pr-merge`)
- User can instruct to merge by running `/pr-merge` or explicitly saying "merge this"

**Previous Step**: Iterations complete via `/pr-iterate`

**Prerequisites**:

- All review feedback addressed
- All CI checks passing (verified)
- Copilot review satisfied

**Behavior**:
- **With explicit merge instruction**: Verifies CI, then merges PR
- **Without merge instruction**: Verifies CI, posts status update, awaits approval

## Final Verification

### 1. Verify CI Passes (CRITICAL)

```bash
# This MUST return exit code 0
gh pr checks <PR>

# If exit code 1: NOT ready
# Go back to /pr-iterate
```

### 2. Check Review Status

```bash
# All threads resolved?
gh talk status --pr <PR>

# Copilot satisfied?
gh pr view <PR> --json reviewDecision --jq '.reviewDecision'
```

### 3. Self-Review Checklist

- [ ] **All CI checks passing** (verified `gh pr checks` exit code 0)
- [ ] All review comments addressed
- [ ] All review threads resolved
- [ ] All resolved comments hidden
- [ ] Copilot review satisfied
- [ ] Tests added (100% coverage for new code)
- [ ] Code formatted (`make fmt`)
- [ ] Documentation updated
- [ ] Coverage maintained at >60%
- [ ] **PR description updated** (reflects final state)
- [ ] AGENTS.md updated (if new patterns)
- [ ] Branch up to date with main

## Post Status Update

**CRITICAL: ALWAYS hide old status updates FIRST:**

```bash
# Step 1: Hide ALL previous status updates (REQUIRED)
gh pr view <PR> --comments --json comments | \
  jq -r '.comments[] | select(.body | contains("Status Update")) | .id' | \
  xargs -I {} gh talk hide {} --reason outdated

# Step 2: Then post new status
gh pr comment <PR> --body "## Status Update

‚úì All checks passing (verified: gh pr checks returned 0)
‚úì All feedback addressed
‚úì All threads resolved
‚úì Tests added
‚úì Documentation updated

Awaiting your approval to merge.

ü§ñ Cursor"
```

**CRITICAL Rules:**

- **ALWAYS hide old status updates BEFORE posting new one** (prevents clutter)
- Title: "Status Update" only (not "Final" or "Ready")
- NEVER claim ready if CI failing/pending
- Verify exit code 0 before posting
- Include agent signature

## Request Merge

**Merge Policy:**

- **CAN merge** when explicitly instructed by user (e.g., user runs `/pr-merge` or directly says "merge this")
- **DO NOT merge** automatically without explicit instruction
- **ALWAYS verify** `gh pr checks` returns exit code 0 before merging

**When user explicitly instructs to merge:**

```bash
# Verify one final time
gh pr checks <PR>  # MUST be exit code 0

# Merge the PR
gh pr merge <PR> --squash --delete-branch

# Confirm completion
echo "‚úì Merged and branch deleted"
```

**When verification complete but no explicit merge instruction:**

```bash
gh pr comment <PR> --body "## Status Update

‚úì All checks passing (verified: gh pr checks returned 0)
‚úì All feedback addressed
‚úì Tests added
‚úì Documentation updated

Awaiting your approval to merge.

ü§ñ Cursor"
```

## Post-Merge Cleanup

**After PR is merged:**

```bash
# Update local main
git checkout main
git pull origin main

# Delete feature branch (if not auto-deleted by --delete-branch)
git branch -d <branch-name>

# Delete remote if not auto-deleted
git push origin --delete <branch-name>
```

**Note:** If using `gh pr merge --delete-branch`, the remote branch is automatically deleted.

## Anti-Patterns

‚ùå **Merging without explicit instruction** - Only merge when user directly instructs
‚ùå **Claiming ready without exit code 0** - Verify CI!
‚ùå **Skipping status update** - Keep PR updated
‚ùå **Leaving old status comments** - Hide as outdated
‚ùå **Merging while CI failing** - Always verify `gh pr checks` returns 0

## Quick Reference

```bash
# Verify ready
gh pr checks <PR>  # Must be exit code 0
gh talk status

# FIRST: Hide ALL old status updates (CRITICAL STEP)
gh pr view <PR> --comments --json comments | \
  jq -r '.comments[] | select(.body | contains("Status Update")) | .id' | \
  xargs -I {} gh talk hide {} --reason outdated

# THEN: Post status update
gh pr comment <PR> --body "...
ü§ñ Cursor"

# When user instructs to merge
gh pr checks <PR>  # Verify one final time (must be 0)
gh pr merge <PR> --squash --delete-branch

# After merge (cleanup)
git checkout main && git pull
git branch -d <branch>
```

## Cycle Complete

**For next PR:**
‚Üí Use `/pr-create` to start fresh

---

**Related**:

- `pr-create.mdc` - Creating PRs
- `pr-iterate.mdc` - Handling feedback
- `AGENTS.md` - Code standards

ü§ñ *Generated by Cursor*
