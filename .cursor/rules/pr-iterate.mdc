---
description: "Iterate on PR: monitor CI, address feedback, push fixes"
alwaysApply: false
---

# Iterating on Pull Requests

**Purpose**: Handle CI monitoring, review feedback, and iterative improvements on an open PR.

**When to Use**: After PR created, during review cycle (invoke with `/pr-iterate`)

**Previous Step**: PR created via `/pr-create`

**Prerequisites**:

- Open PR on feature branch
- Copilot review requested
- CI running or completed

## Monitor CI and Fix Failures

**Check CI status (exit code 0 = ALL pass):**

```bash
gh pr checks <PR>
# Exit code 0 = all pass
# Exit code 1 = failures or pending
```

**If ANY checks fail:**

```bash
# View failed logs
gh run view --log-failed

# Fix the issue
# Commit and push fix
# Wait for CI re-run

# NEVER claim "ready" until this returns exit code 0:
gh pr checks <PR>
```

**Watch run in real-time:**

```bash
gh run watch
```

**CRITICAL**: Do NOT proceed until `gh pr checks` returns exit code 0

## Address Review Feedback

**Check ALL comment types:**

```bash
# 1. General PR comments
gh pr view <PR> --comments

# 2. Inline review comments (use gh-talk!)
gh talk list threads --pr <PR>

# 3. Review decision
gh pr view <PR> --json reviewDecision --jq '.reviewDecision'
```

**For EACH comment/thread:**

### 1. Respond BEFORE Fixing

```bash
gh talk reply PRRT_xxx "ğŸ‘€ Looking into this

ğŸ¤– Cursor"
```

### 2. Make the Fix

- Implement the change
- Write tests (100% coverage for new code)
- Update docs if needed

### 3. Test the Fix

```bash
make fmt  # Format first
make ci   # Verify locally
```

### 4. Commit and Push

```bash
git add <files>
git commit --author="Cursor <cursor@noreply.local>" -m "Address review comment about X

Fixed by doing Y.

ğŸ¤– Generated by Cursor"

git push

# IMMEDIATELY REQUEST RE-REVIEW (REQUIRED)
gh pr comment <PR> --body "@github-copilot please re-review"
```

**CRITICAL**: ALWAYS request Copilot re-review immediately after pushing changes

**Note**: Must use comment @mention (Copilot not a regular reviewer)

### 5. Respond AFTER Fixing

```bash
gh talk reply PRRT_xxx "Fixed in latest commit. [Brief explanation]

ğŸ¤– Cursor" --resolve --react ğŸ‘
```

### 6. Clean Up

```bash
# Hide original comment after resolving
gh talk hide PRRC_xxx --reason resolved
```

### 7. Post Status Updates (If Significant Progress)

**ALWAYS hide old status updates first:**

```bash
# Hide all previous status updates
gh pr view <PR> --comments --json comments | \
  jq -r '.comments[] | select(.body | contains("Status Update")) | .id' | \
  xargs -I {} gh talk hide {} --reason outdated

# Then post new update
gh pr comment <PR> --body "## Status Update

âœ“ Items completed
â³ Items in progress (e.g., CI running)
âŒ Items blocked

ğŸ¤– Cursor"
```

**CRITICAL**: ALWAYS hide old updates before posting new one

**Emoji Usage:** See `/emoji-semantics` for complete guide

**Standard pattern:**
- ğŸ‘€ Before fixing (acknowledging)
- ğŸ‘ After fixing (confirmation)
- â¤ï¸ For helpful suggestions
- ğŸ‰ For great feedback
- ğŸ˜• If unclear (ask clarification)

## Keep PR Updated

**Before each push, check if behind:**

```bash
gh pr view <PR> --json mergeStateStatus --jq '.mergeStateStatus'

# If "BEHIND", rebase:
git fetch origin main
git rebase origin/main
# Fix conflicts if any
git push --force-with-lease
```

**Update PR description when:**

- Scope expanded (more files changed)
- Approach changed significantly
- New issues closed
- Significant commits added

```bash
gh pr edit <PR> --body "Updated description

...

---
ğŸ¤– *Generated by Cursor*"
```

## Common Patterns

### Quick Fix Cycle

```bash
# For each comment:
gh talk reply PRRT_xxx "ğŸ‘€ Working on this

ğŸ¤– Cursor"

# Fix, test, commit, push
make fmt && make ci
git commit --author="Cursor <cursor@noreply.local>" -m "Fix X

ğŸ¤– Generated by Cursor"
git push

# Respond and resolve
gh talk reply PRRT_xxx "Fixed in this commit

ğŸ¤– Cursor" --resolve --react ğŸ‘

gh talk hide PRRC_xxx --reason resolved
```

### Rebase and Continue

```bash
git fetch && git rebase origin/main
git push --force-with-lease

# IMMEDIATELY REQUEST RE-REVIEW (REQUIRED)
gh pr comment <PR> --body "@github-copilot please re-review"
```

## Anti-Patterns

âŒ **Claiming ready while CI failing** - Check exit code!
âŒ **Accumulating fixes** - Push after each fix
âŒ **Forgetting to respond** - Always acknowledge before fixing
âŒ **NOT requesting re-review after push** - REQUIRED immediately after git push
âŒ **Skipping gh talk** - Use our own tool!

## Quick Reference

```bash
# Check CI (wait for exit code 0)
gh pr checks <PR>

# Address feedback
gh talk list threads
gh talk reply PRRT_xxx "ğŸ‘€ Looking

ğŸ¤– Cursor"
# fix
make fmt && make ci && git push

# IMMEDIATELY re-review (REQUIRED)
gh pr comment <PR> --body "@github-copilot please re-review"

# Then respond
gh talk reply PRRT_xxx "Fixed

ğŸ¤– Cursor" --resolve --react ğŸ‘
gh talk hide PRRC_xxx --reason resolved
```

## Next Steps

**When all feedback addressed and CI passing:**
â†’ Use `/pr-merge` for final review and merge request

---

**Related**:

- `pr-create.mdc` - Creating the PR
- `pr-merge.mdc` - Final review and merge
- `AGENTS.md` - Code standards

ğŸ¤– *Generated by Cursor*
